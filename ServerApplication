package com.iit.cao.pa3;

import com.iit.cao.pa3.Server.ServerThread;
import com.iit.cao.pa3.pojo.Node;
import com.iit.cao.pa3.utils.YamlUtil;

import java.util.ArrayList;
import java.util.List;

public class ServerApplication {

    private static final List<Node> superPeers = new ArrayList<>();

    public static void readConfig() {
        for(int i = 1; i < 11; i++) {
            Node superPeerNode = new Node();
            String key = "SuperPeer#V" + i;
            String ip = (String) YamlUtil.getInstance().getValue(key, "ip");
            Integer serverPort = (Integer) YamlUtil.getInstance().getValue(key, "serverPort");
            Integer clientPort = (Integer) YamlUtil.getInstance().getValue(key, "clientPort");
            Object links = YamlUtil.getInstance().getValue(key, "linkNodes");
            List<Node> nodes = YamlUtil.transferMapToObject(links);
            superPeerNode.setIp(ip);
            superPeerNode.setClientPort(clientPort);
            superPeerNode.setNodeName(key);
            superPeerNode.setServerPort(serverPort);
            superPeerNode.setLinkNodeList(nodes);
            superPeers.add(superPeerNode);
        }
    }

    public static void main(String[] args) {
        readConfig();
        for(Node node: superPeers) {
            ServerThread server = new ServerThread(node.getNodeName(), node.getIp(), node.getServerPort());
            System.out.println(node.getNodeName() + " inserted into database ...");
            server.addServer();
            System.out.println(node.getNodeName() + " continues to provide services ...");
            server.start();
        }
    }

}
