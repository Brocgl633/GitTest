package IIT_550_hw4;

import java.io.*;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

public class PeerNode_1 {

    private static List<String> regDirPathList = Collections.synchronizedList(new ArrayList<>());

    private static final int CLIENT_SOCKET_PORT_1 = 12233;

    private static final int SERVER_SOCKET_PORT_1 = 22233;

    private static final String BACKUP_PATH = "backupfiles/";

    public static void main(String[] args) throws IOException {
        System.out.println("****** Peer node CLIENT mode STARTED ******");
        new Client().start();

        System.out.println("****** Peer node SERVER mode STARTED ******");
        ServerSocket serverSocket = new ServerSocket(SERVER_SOCKET_PORT_1);
        try {
            while (true) {
                new Server(serverSocket.accept()).start();
            }
        } finally {
            serverSocket.close();
        }
    }

    private static class Client extends Thread {
        public void run() {
            Socket socket = null;
            ObjectInputStream in = null;
            BufferedReader input = null;
            ObjectOutputStream out = null;
            Request clientRequest = null;
            Response serverResponse = null;

            try {
                input = new BufferedReader(new InputStreamReader(System.in));
                System.out.println("Please input Peer node IP :");
                String ip = input.readLine();
                if (ip.trim().length() == 0 || !IPServer.validate(ip)) {
                    System.out.println("Invalid Central indexing server node IP.");
                    System.exit(0);
                }

                long startTime, endTime, time;

                socket = new Socket(ip, CLIENT_SOCKET_PORT_1);
                out = new ObjectOutputStream(socket.getOutputStream());
                out.flush();
                in = new ObjectInputStream(socket.getInputStream());
                serverResponse = (Response) in.readObject();
                System.out.print((String) serverResponse.getResponseData());

                String isBackup = input.readLine();
                clientRequest = new Request();
                clientRequest.setRequestType("BACK_UP");
                clientRequest.setRequestData(isBackup);
                out.writeObject(clientRequest);

                if (isBackup.equalsIgnoreCase("Y")) {
                    regDirPathList.add(BACKUP_PATH);
                    serverResponse = (Response) in.readObject();
                    ConcurrentHashMap<String, ArrayList<String>> spellIpFileMap
                            = (ConcurrentHashMap<String, ArrayList<String>>) serverResponse.getResponseData();
                    new BackupService(spellIpFileMap, regDirPathList).start();
                }

                // handle previous map of ip to directory
                serverResponse = (Response) in.readObject();
                ArrayList<String> ipDirList = (ArrayList<String>) serverResponse.getResponseData();
                if (ipDirList != null) {
                    for (String x : ipDirList) {
                        if (!regDirPathList.contains(x)) {
                            regDirPathList.add(x);
                        }
                    }
                }

                while (true) {
                    System.out.println("\n****** Peer-to-Peer mode file downloading system ******");
                    System.out.println("1.Register files");
                    System.out.println("2.Get files list");
                    System.out.println("3.Search or download or print a file");
                    System.out.println("4.Delete file");
                    System.out.println("5.Unregister files of Peer node [" + ip + "]");
                    System.out.println("6.Print client log of Peer node [" + ip + "]");
                    System.out.println("7.Print server log of Peer node [" + ip + "]");
                    System.out.println("8.Print backup log of Peer node [" + ip + "]");
                    System.out.println("9.Exit");
                    System.out.print("Please input number : ");

                    int option;

                    try {
                        option = Integer.parseInt(input.readLine());
                    } catch (NumberFormatException e) {
                        System.out.println("Input is wrong. Please try again.");
                        continue;
                    }

                    switch (option) {
                        case 1:
                            System.out.println("The path of the registered files : ");
                            String path = input.readLine();
                            if (path.trim().length() == 0) {
                                System.out.println("Invalid Path.");
                                continue;
                            }

                            List<File> fileObjList = FileUtil.getFileObj(path);
                            ArrayList<String> files = FileUtil.getFiles(path);
                            File file = new File(path);
                            if (file.isFile()) {
                                String dirPath = path.substring(0, path.lastIndexOf("/"));
                                regDirPathList.add(dirPath);
                                files.add(0, dirPath);
                            } else if (file.isDirectory()) {
                                regDirPathList.add(path);
                                files.add(0, path);
                            }

                            if (files.size() > 1) {
                                startTime = System.currentTimeMillis();

                                clientRequest = new Request();
                                clientRequest.setRequestType("REGISTER");
                                Object[] data = new Object[3];
                                data[0] = files;
                                data[1] = regDirPathList;
                                data[2] = fileObjList;
                                clientRequest.setRequestData(data);
                                out.writeObject(clientRequest);

                                serverResponse = (Response) in.readObject();
                                endTime = System.currentTimeMillis();
                                time = endTime - startTime;

                                if (serverResponse.getResponseCode() == 200) {
                                    System.out.println(
                                            (files.size() - 1) + " files have registered. Take " + time + " ms.");
                                } else {
                                    System.out.println("Unable to register files.");
                                }
                            } else {
                                System.out.println("There are no more files in path [ " + path + " ].");
                            }
                            break;
                        case 2:
                            System.out.println("\nAll file are as follows:");
                            clientRequest = new Request();
                            clientRequest.setRequestType("GET_FILES_LIST");
                            clientRequest.setRequestData("Get all files list.");
                            out.writeObject(clientRequest);

                            serverResponse = (Response) in.readObject();
                            if (serverResponse.getResponseCode() == 200) {
                                List<String> allFileInfoList = (List<String>) serverResponse.getResponseData();
                                for (String fileInfo : allFileInfoList) {
                                    System.out.println(fileInfo);
                                }
                            }
                            break;
                        case 3:
                            System.out.println("The file name you want to search : ");
                            String fileName = input.readLine();
                            String clientIp;

                            startTime = System.currentTimeMillis();

                            clientRequest = new Request();
                            clientRequest.setRequestType("SEARCH");
                            clientRequest.setRequestData(fileName);
                            out.writeObject(clientRequest);

                            serverResponse = (Response) in.readObject();
                            endTime = System.currentTimeMillis();
                            time = endTime - startTime;
                            if (serverResponse.getResponseCode() == 200) {
                                System.out.println("File found. Searching takes " + time + " ms.");

                                HashMap<Integer, String> clientIdIpMap
                                        = (HashMap<Integer, String>) serverResponse.getResponseData();
                                if (clientIdIpMap != null) {
                                    for (Map.Entry<Integer, String> entry : clientIdIpMap.entrySet()) {
                                        System.out.println("Peer node id : " + entry.getKey());
                                        System.out.println("Peer node ip : " + entry.getValue());
                                    }
                                }

                                if (fileName.trim().endsWith(".txt")) {
                                    System.out.print("Download(D) or print(P) this file? Input(D/P): ");
                                    String dOrP = input.readLine();

                                    if (clientIdIpMap.size() > 1) {
                                        System.out.print("Choose one Peer node id : ");
                                        int clientId = Integer.parseInt(input.readLine());
                                        clientIp = clientIdIpMap.get(clientId);
                                    } else {
                                        Map.Entry<Integer, String> entry = clientIdIpMap.entrySet().iterator().next();
                                        clientIp = entry.getValue();
                                    }

                                    System.out.print("Input the start offset : ");
                                    int startOffset = Integer.parseInt(input.readLine());
                                    System.out.print("Input the chuck size : ");
                                    int chuckSize = Integer.parseInt(input.readLine());
                                    /**
                                     *
                                     */
                                    clientRequest = new Request();
                                    clientRequest.setRequestType("UPDATE_SPLIT_FILE");
                                    clientRequest.setRequestData(clientIp);
                                    out.writeObject(clientRequest);

                                    downloadFile(clientIp, fileName, out, in, startOffset, chuckSize);

                                    System.out.println(
                                            "The file has downloaded in the current path's sub-directory '/downloads'.");
                                    if (dOrP.equalsIgnoreCase("P")) {
                                        FileUtil.printFile(fileName);
                                    }
                                } else {
                                    System.out.print("Download or not? (Y/N): ");
                                    String download = input.readLine();
                                    if (download.equalsIgnoreCase("Y")) {
                                        if (clientIdIpMap.size() > 1) {
                                            System.out.print("Choose one Peer node id : ");
                                            int clientId = Integer.parseInt(input.readLine());
                                            clientIp = clientIdIpMap.get(clientId);
                                        } else {
                                            Map.Entry<Integer, String> entry = clientIdIpMap.entrySet()
                                                    .iterator()
                                                    .next();
                                            clientIp = entry.getValue();
                                        }

                                        System.out.print("Input the start offset : ");
                                        int startOffset = Integer.parseInt(input.readLine());
                                        System.out.print("Input the chuck size : ");
                                        int chuckSize = Integer.parseInt(input.readLine());
                                        /**
                                         *
                                         */
                                        clientRequest = new Request();
                                        clientRequest.setRequestType("UPDATE_SPLIT_FILE");
                                        clientRequest.setRequestData(clientIp);
                                        out.writeObject(clientRequest);

                                        downloadFile(clientIp, fileName, out, in, startOffset, chuckSize);
                                    }
                                }
                            } else {
                                System.out.println((String) serverResponse.getResponseData());
                            }
                            break;
                        case 4:
                            System.out.println("The file name you want to delete : ");
                            String fName = input.readLine();
                            String chooseIp;
                            int clientId;

                            clientRequest = new Request();
                            clientRequest.setRequestType("SEARCH");
                            clientRequest.setRequestData(fName);
                            out.writeObject(clientRequest);

                            serverResponse = (Response) in.readObject();
                            if (serverResponse.getResponseCode() == 200) {
                                HashMap<Integer, String> clientIdIpMap
                                        = (HashMap<Integer, String>) serverResponse.getResponseData();
                                if (clientIdIpMap != null) {
                                    for (Map.Entry<Integer, String> entry : clientIdIpMap.entrySet()) {
                                        System.out.println("Peer node id : " + entry.getKey());
                                        System.out.println("Peer node ip : " + entry.getValue());
                                    }
                                }

                                if (clientIdIpMap.size() > 1) {
                                    System.out.print("Choose one Peer node id : ");
                                    clientId = Integer.parseInt(input.readLine());
                                    chooseIp = clientIdIpMap.get(clientId);
                                } else {
                                    Map.Entry<Integer, String> entry = clientIdIpMap.entrySet().iterator().next();
                                    clientId = entry.getKey();
                                    chooseIp = entry.getValue();
                                }

                                startTime = System.currentTimeMillis();

                                clientRequest = new Request();
                                clientRequest.setRequestType("DELETE");
                                Object[] data = new Object[3];
                                data[0] = clientId;
                                data[1] = chooseIp;
                                data[2] = fName;
                                clientRequest.setRequestData(data);
                                out.writeObject(clientRequest);

                                serverResponse = (Response) in.readObject();
                                endTime = System.currentTimeMillis();
                                time = endTime - startTime;
                                if (serverResponse.getResponseCode() == 200) {
                                    System.out.println("Deleting file takes " + time + " ms.");
                                    System.out.println((String) serverResponse.getResponseData());
                                }
                            } else {
                                System.out.println((String) serverResponse.getResponseData());
                            }
                            break;
                        case 5:
                            System.out.print("Please confirm whether to un-register? (Y/N): ");
                            String confirm = input.readLine();

                            if (confirm.equalsIgnoreCase("Y")) {
                                startTime = System.currentTimeMillis();
                                clientRequest = new Request();
                                clientRequest.setRequestType("UNREGISTER");
                                clientRequest.setRequestData("Unregister files of Peer node [" + ip + "]");
                                out.writeObject(clientRequest);

                                endTime = System.currentTimeMillis();
                                time = endTime - startTime;
                                serverResponse = (Response) in.readObject();
                                System.out.println(
                                        (String) serverResponse.getResponseData() + " Take " + time + " ms.");
                            }
                            break;
                        case 6:
                            (new LogUtil("PeerNode")).print();
                            break;
                        case 7:
                            (new LogUtil("IndexingServer")).print();
                            break;
                        case 8:
                            (new LogUtil("Backup")).print();
                            break;
                        case 9:
                            clientRequest = new Request();
                            clientRequest.setRequestType("DISCONNECT");
                            clientRequest.setRequestData("Disconnecting from server.");
                            out.writeObject(clientRequest);
                            System.out.println("Thanks for using the system.");
                            System.exit(0);
                            break;
                        default:
                            System.out.println("Input is wrong. Please try again.");
                            break;
                    }
                }
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                try {
                    if (out != null) {
                        out.close();
                    }
                    if (in != null) {
                        in.close();
                    }
                    if (socket != null) {
                        socket.close();
                    }
                    if (input != null) {
                        input.close();
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }

        private void downloadFile(String ip,
                                  String fileName,
                                  ObjectOutputStream out,
                                  ObjectInputStream in,
                                  int startOffset,
                                  int chuckSize) {
            boolean isDownloaded = false;
            long startTime = System.currentTimeMillis();

            if (!FileUtil.downloadPartFile(ip, SERVER_SOCKET_PORT_1, fileName, startOffset, chuckSize)) {
                try {
                    Request peerRequest = new Request();
                    peerRequest.setRequestType("GET_BACKUP_NODES");
                    peerRequest.setRequestData("Send list of backup nodes.");
                    out.writeObject(peerRequest);

                    Response serverResponse = (Response) in.readObject();
                    List<String> backupClientIpList = (List<String>) serverResponse.getResponseData();

                    for (String backupIp : backupClientIpList) {
                        if (FileUtil.downloadPartFile(backupIp, SERVER_SOCKET_PORT_1, fileName, startOffset, chuckSize)) {
                            isDownloaded = true;
                            break;
                        }
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                }
            } else {
                isDownloaded = true;
            }

            long endTime = System.currentTimeMillis();
            long time = endTime - startTime;

            if (isDownloaded) {
                System.out.println("File downloaded successfully. Take " + time + " ms.");
            } else {
                System.out.println("Unable to download file. Try again later.");
            }
        }
    }

    private static class Server extends Thread {
        private Map<String, Map<File, byte[]>> fileSplitRegMap;

        private Socket socket;

        private LogUtil log = new LogUtil("PeerNode");

        public Server(Socket socket) {
            this.socket = socket;
        }

        public void run() {
            OutputStream out = null;
            ObjectInputStream in = null;
            ObjectOutputStream oOut = null;
            BufferedInputStream fileInput = null;

            try {
                String clientIp = socket.getInetAddress().getHostAddress();
                in = new ObjectInputStream(socket.getInputStream());
                Request request = (Request) in.readObject();

                if (request.getRequestType().equalsIgnoreCase("DOWNLOAD")) {
                    logPrint("Serving DOWNLOAD request for " + clientIp);
                    logPrint("***** : 1");
                    String fileName = (String) request.getRequestData();
                    logPrint("***** : 1");
                    oOut = new ObjectOutputStream(socket.getOutputStream());
                    logPrint("***** : 1");
                    Response response = new Response();
                    logPrint("***** : " + fileSplitRegMap.get(fileName));
                    response.setResponseData(fileSplitRegMap.get(fileName));
                    oOut.writeObject(response);
                    logPrint("File part information map sent successfully.");
                    System.out.println();
                } else if (request.getRequestType().equalsIgnoreCase("UPDATE_FILE_PART")) {
                    logPrint("Serving UPDATE_FILE_PART request for " + clientIp);
                    logPrint("UPDATE_FILE_PART start ...");
                    fileSplitRegMap = (Map<String, Map<File, byte[]>>) request.getRequestData();
                    logPrint("UPDATE_FILE_PART update the file part information : " + fileSplitRegMap);
                    System.out.println();
                }  else if (request.getRequestType().equalsIgnoreCase("UPDATE_BACKUP_DATA")) {
                    logPrint("Serving UPDATE_BACKUP_DATA request for " + clientIp);
                    logPrint("UPDATE_BACKUP_DATA start ...");
                    Object[] data = (Object[]) request.getRequestData();
                    ConcurrentHashMap<String, ArrayList<String>> spellIpFileMap = (ConcurrentHashMap<String, ArrayList<String>>) data[0];
                    List<String> regDirPathList = (List<String>) data[1];
                    System.out.println("UPDATE_BACKUP_DATA get spellIpFileMap: " + spellIpFileMap.toString());
                    new BackupService(spellIpFileMap, regDirPathList).start();
                } else if (request.getRequestType().equalsIgnoreCase("REMOVE_FILE")) {
                    logPrint("Serving REMOVE_FILE request for " + clientIp);
                    logPrint("REMOVE_FILE start ...");
                    ArrayList<String> deleteFileList = (ArrayList<String>) request.getRequestData();
                    System.out.println("REMOVE_FILE list: " + deleteFileList.toString());
                    for (String fileInfo : deleteFileList) {
                        String[] split = fileInfo.split(":");
                        File file = new File(BACKUP_PATH + split[0]);
                        file.delete();
                    }
                }
            } catch (Exception e) {
                logPrint("ERROR: " + e);
            } finally {
                try {
                    if (out != null) {
                        out.close();
                    }
                    if (in != null) {
                        in.close();
                    }
                    if (oOut != null) {
                        oOut.close();
                    }
                    if (fileInput != null) {
                        fileInput.close();
                    }
                    if (socket != null) {
                        socket.close();
                    }
                } catch (IOException ioe) {
                    ioe.printStackTrace();
                }
                Thread.currentThread().interrupt();
            }
        }

        @Override
        public void interrupt() {
            log.close();
            super.interrupt();
        }

        private void logPrint(String message) {
            log.write(message);
            System.out.println(message);
        }
    }
}
